name: Update Dynamic Profile

on:
  schedule:
    - cron: "0 */6 * * *"   # Runs every 6 hours
  workflow_dispatch:        # Allows manual testing

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch recent activity (Smart Filtered)
        run: |
          echo "" > activity.md
          
          # 1. Fetch last 20 events
          # 2. Select only PushEvents
          # 3. FILTER OUT: Merges, Chores, Docs, Typos, WIPs
          # 4. Limit to top 5 items
          RECENT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/users/raymond-01/events?per_page=20" \
          | jq -c '.[] | select(.type=="PushEvent")' \
          | jq -c 'select(.payload.commits[0].message | test("Merge|chore|docs|typo|wip"; "i") | not)' \
          | head -n 5)
          
          if [ -z "$RECENT" ]; then
            echo "> *Heads down coding—no major public updates today.*" > activity.md
          else
            # Outputs: "- [Repo Name] — [Commit Message]"
            echo "$RECENT" | jq -r '"- **\(.repo.name)** — \(.payload.commits[0].message | split("\n")[0])"' >> activity.md
          fi

      - name: Fetch latest repos
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/users/raymond-01/repos?sort=updated&per_page=5" \
          | jq -r '.[] | "- [\(.name)](\(.html_url)) — updated \(.updated_at | sub("T.*"; ""))"' > repos.md

      - name: Inject into README
        run: |
          awk '
            BEGIN {activity=0; projects=0}
            // {print; while ((getline line < "activity.md") > 0) print line; activity=1; next}
            // {activity=0}
            // {print; while ((getline line < "repos.md") > 0) print line; projects=1; next}
            // {projects=0}
            activity==0 && projects==0 {print}
          ' README.md > NEWREADME.md
          
          mv NEWREADME.md README.md

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add README.md
          # Only commit if there are actual changes
          git commit -m "Auto-update profile" || echo "No changes to commit"
          git push
