name: Update Dynamic Profile

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch recent activity
        run: |
          echo "">activity.md
          RECENT=$(curl -s "https://api.github.com/users/raymond-01/events?per_page=10" | jq '.[] | select(.type=="PushEvent")')
          if [ -z "$RECENT" ]; then
            echo "" > activity.md
          else
            echo "### ðŸ”¥ Latest Activity" >> activity.md
            echo "" >> activity.md
            echo "$RECENT" | jq -r '"- \(.repo.name) â€” pushed on \(.created_at)"' >> activity.md
          fi

      - name: Fetch latest repos
        run: |
          curl -s "https://api.github.com/users/raymond-01/repos?sort=updated&per_page=5" \
          | jq -r '.[] | "- [\(.name)](\(.html_url)) â€” updated \(.updated_at)"' > repos.md

      - name: Inject into README
        run: |
          awk '
            BEGIN {activity=0; projects=0}
            /<!-- ACTIVITY_SECTION_START -->/ {print; while ((getline line < "activity.md") > 0) print line; activity=1; next}
            /<!-- ACTIVITY_SECTION_END -->/ {activity=0}
            /<!-- PROJECTS_SECTION_START -->/ {print; while ((getline line < "repos.md") > 0) print line; projects=1; next}
            /<!-- PROJECTS_SECTION_END -->/ {projects=0}
            activity==0 && projects==0 {print}
          ' README.md > NEWREADME.md
          mv NEWREADME.md README.md

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add README.md
          git commit -m "Auto-update profile" || exit 0
          git push
